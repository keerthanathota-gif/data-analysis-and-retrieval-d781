<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFR Agentic AI - Intelligent Regulatory Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --border: #e2e8f0;
            --text: #334155;
            --text-light: #64748b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 i {
            font-size: 0.9em;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            font-weight: 300;
        }

        .header-stats {
            display: flex;
            gap: 30px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .stat-item .stat-value {
            font-size: 2em;
            font-weight: 700;
            display: block;
        }

        .stat-item .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: var(--light);
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tab {
            flex: 1;
            min-width: 150px;
            padding: 20px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
        }

        .nav-tab i {
            font-size: 1.2em;
        }

        .nav-tab:hover {
            background: white;
            color: var(--primary);
        }

        .nav-tab.active {
            background: white;
            color: var(--primary);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        /* Content */
        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .card-header i {
            font-size: 2em;
            color: var(--primary);
        }

        .card-header h2 {
            font-size: 1.8em;
            color: var(--dark);
            font-weight: 700;
        }

        .card-description {
            color: var(--text-light);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group label i {
            margin-right: 5px;
            color: var(--primary);
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn i {
            font-size: 1.1em;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #7c3aed 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Checkbox Groups */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--light);
            border-radius: 10px;
            border: 2px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .checkbox-item:hover {
            border-color: var(--primary);
            background: white;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        /* Results */
        .results-container {
            margin-top: 30px;
            padding: 25px;
            background: var(--light);
            border-radius: 12px;
            max-height: 600px;
            overflow-y: auto;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .results-header h3 {
            color: var(--dark);
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-count {
            background: var(--primary);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .result-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .result-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .result-item-title {
            font-weight: 700;
            color: var(--dark);
            font-size: 1.1em;
        }

        .similarity-badge {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .similarity-badge.high {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .similarity-badge.medium {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .result-item-content {
            color: var(--text);
            line-height: 1.6;
        }

        .result-item-content strong {
            color: var(--dark);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-light);
            font-size: 1.1em;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .stat-card-value {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card-label {
            font-size: 1em;
            opacity: 0.95;
            font-weight: 500;
        }

        .stat-card i {
            font-size: 2em;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        /* Visualization Grid */
        .vis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .vis-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border: 1px solid var(--border);
        }

        .vis-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .vis-card-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: var(--light);
        }

        .vis-card-body {
            padding: 20px;
        }

        .vis-card-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vis-card-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .vis-card-link:hover {
            gap: 12px;
            color: var(--primary-dark);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--text);
        }

        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .alert i {
            font-size: 1.3em;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #6ee7b7;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #fcd34d;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #fca5a5;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #93c5fd;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s;
            border-radius: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 1em;
            }

            .nav-tab {
                min-width: 120px;
                padding: 15px 10px;
                font-size: 13px;
            }

            .nav-tab span {
                display: none;
            }

            .tab-content {
                padding: 20px;
            }

            .card {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .vis-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.4s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.3s;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-box {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }

        .info-label {
            color: var(--text-light);
            font-size: 0.9em;
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .info-value {
            color: var(--dark);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-brain"></i>
                    CFR Agentic AI
                </h1>
                <p>Intelligent Analysis & Retrieval System for Code of Federal Regulations</p>
                <div class="header-stats" id="header-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="stat-chapters">0</span>
                        <span class="stat-label">Chapters</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="stat-sections">0</span>
                        <span class="stat-label">Sections</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="stat-embeddings">0</span>
                        <span class="stat-label">Embeddings</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('pipeline')">
                <i class="fas fa-database"></i>
                <span>Pipeline</span>
            </button>
            <button class="nav-tab" onclick="switchTab('analysis')">
                <i class="fas fa-chart-line"></i>
                <span>Analysis</span>
            </button>
            <button class="nav-tab" onclick="switchTab('clustering')">
                <i class="fas fa-project-diagram"></i>
                <span>Clustering</span>
            </button>
            <button class="nav-tab" onclick="switchTab('rag')">
                <i class="fas fa-comments"></i>
                <span>RAG Query</span>
            </button>
            <button class="nav-tab" onclick="switchTab('similarity')">
                <i class="fas fa-search"></i>
                <span>Search</span>
            </button>
            <button class="nav-tab" onclick="switchTab('visualizations')">
                <i class="fas fa-chart-pie"></i>
                <span>Visuals</span>
            </button>
        </div>

        <!-- Pipeline Tab -->
        <div id="pipeline" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-rocket"></i>
                    <h2>Data Pipeline Control</h2>
                </div>
                <p class="card-description">
                    <i class="fas fa-info-circle"></i>
                    Enter CFR URLs to crawl, parse XML files, store in database, and generate AI embeddings. You can add multiple URLs.
                </p>
                
                <div class="form-group">
                    <label><i class="fas fa-link"></i> CFR URLs (one per line)</label>
                    <textarea id="pipeline-urls" rows="4" placeholder="https://www.govinfo.gov/bulkdata/CFR/2025/title-16/
https://www.govinfo.gov/bulkdata/CFR/2025/title-17/">https://www.govinfo.gov/bulkdata/CFR/2025/title-16/</textarea>
                    <small style="color: var(--text-light); display: block; margin-top: 5px;">
                        Example: https://www.govinfo.gov/bulkdata/CFR/YEAR/title-NUMBER/
                    </small>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="runPipeline()">
                        <i class="fas fa-play"></i> Run Complete Pipeline
                    </button>
                    <button class="btn btn-secondary" onclick="getStats()">
                        <i class="fas fa-chart-bar"></i> Get Statistics
                    </button>
                    <button class="btn btn-danger" onclick="resetDatabase()">
                        <i class="fas fa-trash-alt"></i> Reset Database
                    </button>
                </div>
            </div>

            <div id="pipeline-stats" class="stats-grid" style="display: none;"></div>

            <div id="pipeline-results"></div>
            <div id="pipeline-loading" class="loading">
                <div class="spinner"></div>
                <p class="loading-text">Processing pipeline...</p>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-microscope"></i>
                    <h2>Semantic Analysis</h2>
                </div>
                <p class="card-description">
                    Analyze semantic similarity, detect overlaps, check redundancy, and validate data integrity across different levels.
                </p>

                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-layer-group"></i> Analysis Level</label>
                        <select id="analysis-level">
                            <option value="chapter">Chapter Level</option>
                            <option value="subchapter">Subchapter Level</option>
                            <option value="section">Section Level</option>
                        </select>
                    </div>
                </div>

                <div class="checkbox-grid">
                    <div class="checkbox-item">
                        <input type="checkbox" id="check-similarity" checked>
                        <label for="check-similarity"><i class="fas fa-equals"></i> Semantic Similarity</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check-overlap" checked>
                        <label for="check-overlap"><i class="fas fa-copy"></i> Overlap Detection</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check-redundancy" checked>
                        <label for="check-redundancy"><i class="fas fa-clone"></i> Redundancy Check</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="check-parity" checked>
                        <label for="check-parity"><i class="fas fa-check-circle"></i> Parity Check</label>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="runAnalysis()">
                        <i class="fas fa-play"></i> Run Analysis
                    </button>
                    <button class="btn btn-secondary" onclick="getAnalysisSummary()">
                        <i class="fas fa-file-alt"></i> Get Summary
                    </button>
                </div>
            </div>

            <div id="analysis-results"></div>
            <div id="analysis-loading" class="loading">
                <div class="spinner"></div>
                <p class="loading-text">Analyzing data...</p>
            </div>
        </div>

        <!-- Clustering Tab -->
        <div id="clustering" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-sitemap"></i>
                    <h2>K-Means Clustering</h2>
                </div>
                <p class="card-description">
                    Automatically group similar content using K-Means clustering. For chapters and subchapters, clustering is based on their contained sections.
                </p>

                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-layer-group"></i> Clustering Level</label>
                        <select id="cluster-level">
                            <option value="section">Section Level (Direct)</option>
                            <option value="subchapter">Subchapter Level (Aggregated Sections)</option>
                            <option value="chapter">Chapter Level (Aggregated Sections)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-hashtag"></i> Number of Clusters (Optional)</label>
                        <input type="number" id="cluster-n" placeholder="Auto (leave empty)" min="2" max="20">
                        <small style="color: var(--text-light); display: block; margin-top: 5px;">
                            Leave empty for automatic calculation
                        </small>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="performClustering()">
                        <i class="fas fa-project-diagram"></i> Perform Clustering
                    </button>
                    <button class="btn btn-success" onclick="generateVisualizations()">
                        <i class="fas fa-image"></i> Generate Visualizations
                    </button>
                </div>
            </div>

            <div id="clustering-results"></div>
            <div id="clustering-loading" class="loading">
                <div class="spinner"></div>
                <p class="loading-text">Clustering in progress...</p>
            </div>
        </div>

        <!-- RAG Query Tab -->
        <div id="rag" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-robot"></i>
                    <h2>RAG Query Interface</h2>
                </div>
                <p class="card-description">
                    Use natural language to search and retrieve relevant regulatory content. Powered by semantic embeddings and AI.
                </p>

                <div class="form-group">
                    <label><i class="fas fa-keyboard"></i> Enter Your Query</label>
                    <textarea id="rag-query" placeholder="Example: What are the regulations about consumer protection and privacy?"></textarea>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-filter"></i> Search Level</label>
                        <select id="rag-level">
                            <option value="all">All Levels</option>
                            <option value="chapter">Chapter Only</option>
                            <option value="subchapter">Subchapter Only</option>
                            <option value="section">Section Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-list-ol"></i> Top K Results</label>
                        <input type="number" id="rag-topk" value="10" min="1" max="50">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="queryRAG()">
                    <i class="fas fa-search"></i> Search Database
                </button>
            </div>

            <div id="rag-results"></div>
            <div id="rag-loading" class="loading">
                <div class="spinner"></div>
                <p class="loading-text">Searching database...</p>
            </div>
        </div>

        <!-- Similarity Search Tab -->
        <div id="similarity" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clone"></i>
                    <h2>Find Similar Items</h2>
                </div>
                <p class="card-description">
                    Search for a specific chapter, subchapter, or section to find the most similar related items based on semantic similarity.
                </p>

                <div class="form-group">
                    <label><i class="fas fa-search"></i> Item Name or Keywords</label>
                    <input type="text" id="sim-name" placeholder="Example: Consumer Protection">
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Search Type</label>
                        <select id="sim-type">
                            <option value="chapter">Chapter</option>
                            <option value="subchapter">Subchapter</option>
                            <option value="section">Section</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-list-ol"></i> Top K Results</label>
                        <input type="number" id="sim-topk" value="10" min="1" max="50">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="findSimilar()">
                    <i class="fas fa-search-plus"></i> Find Similar Items
                </button>
            </div>

            <div id="similarity-results"></div>
            <div id="similarity-loading" class="loading">
                <div class="spinner"></div>
                <p class="loading-text">Finding similar items...</p>
            </div>
        </div>

        <!-- Visualizations Tab -->
        <div id="visualizations" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-area"></i>
                    <h2>Cluster Visualizations</h2>
                </div>
                <p class="card-description">
                    Generate and explore beautiful visualizations of your clustering results. View 2D plots, 3D interactive charts, and comprehensive reports.
                </p>
                <div id="visualizations-content" class="vis-grid">
                    <div class="empty-state">
                        <i class="fas fa-chart-pie"></i>
                        <h3>No Visualizations Yet</h3>
                        <p>Go to the Clustering tab and click "Generate Visualizations" to create beautiful charts and plots.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        
        // Initialize on load
        window.addEventListener('load', () => {
            getStats();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.nav-tab').classList.add('active');
        }

        async function runPipeline() {
            const loading = document.getElementById('pipeline-loading');
            const results = document.getElementById('pipeline-results');
            const urlsText = document.getElementById('pipeline-urls').value.trim();
            
            if (!urlsText) {
                results.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Please enter at least one CFR URL</strong>
                    </div>
                `;
                return;
            }
            
            // Split URLs by newline and filter empty lines
            const urls = urlsText.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);
            
            loading.classList.add('active');
            results.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/api/pipeline/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: urls })
                });
                const data = await response.json();
                
                results.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Pipeline Started!</strong><br>
                            Processing ${data.num_urls} URL(s) in the background.<br>
                            <small style="margin-top: 5px; display: block;"><strong>URLs:</strong> ${data.urls.join(', ')}</small>
                        </div>
                    </div>
                    <div id="pipeline-progress" style="margin-top: 20px;">
                        <div style="background: var(--light); border-radius: 12px; height: 30px; overflow: hidden; position: relative;">
                            <div id="progress-bar" style="background: linear-gradient(90deg, var(--primary), var(--accent)); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="margin-top: 10px; text-align: center; font-weight: 600;">
                            <span id="progress-text">Starting...</span>
                        </div>
                    </div>
                `;
                
                // Start polling for status
                pollPipelineStatus();
                
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
                loading.classList.remove('active');
            }
        }
        
        let statusPollingInterval = null;
        
        async function pollPipelineStatus() {
            // Clear any existing interval
            if (statusPollingInterval) {
                clearInterval(statusPollingInterval);
            }
            
            statusPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/pipeline/status`);
                    const status = await response.json();
                    
                    updatePipelineProgress(status);
                    
                    // Stop polling if completed or error
                    if (status.state === 'completed' || status.state === 'error') {
                        clearInterval(statusPollingInterval);
                        document.getElementById('pipeline-loading').classList.remove('active');
                        
                        if (status.state === 'completed') {
                            showPipelineCompletion(status);
                        } else if (status.state === 'error') {
                            const results = document.getElementById('pipeline-results');
                            results.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <strong>Pipeline Failed:</strong> ${status.error_message || 'Unknown error'}
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 2000); // Poll every 2 seconds
        }
        
        function updatePipelineProgress(status) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar && progressText) {
                progressBar.style.width = status.progress + '%';
                progressText.textContent = `${status.current_step || 'Processing'}... (${status.progress}%)`;
            }
        }
        
        function showPipelineCompletion(status) {
            const results = document.getElementById('pipeline-results');
            const statsDiv = document.getElementById('pipeline-stats');
            
            if (status.stats && Object.keys(status.stats).length > 0) {
                // Show completion message
                results.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Pipeline Completed Successfully!</strong><br>
                            All data has been processed and stored in the database.
                        </div>
                    </div>
                `;
                
                // Show stats
                statsDiv.style.display = 'grid';
                statsDiv.innerHTML = `
                    <div class="stat-item">
                        <i class="fas fa-book stat-icon"></i>
                        <div class="stat-value">${status.stats.chapters || 0}</div>
                        <div class="stat-label">Chapters</div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-layer-group stat-icon"></i>
                        <div class="stat-value">${status.stats.subchapters || 0}</div>
                        <div class="stat-label">Subchapters</div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-folder stat-icon"></i>
                        <div class="stat-value">${status.stats.parts || 0}</div>
                        <div class="stat-label">Parts</div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-file-alt stat-icon"></i>
                        <div class="stat-value">${status.stats.sections || 0}</div>
                        <div class="stat-label">Sections</div>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-vector-square stat-icon"></i>
                        <div class="stat-value">${status.stats.embeddings || 0}</div>
                        <div class="stat-label">Embeddings</div>
                    </div>
                `;
                
                // Update header stats
                document.getElementById('stat-chapters').textContent = status.stats.chapters || 0;
                document.getElementById('stat-sections').textContent = status.stats.sections || 0;
                document.getElementById('stat-embeddings').textContent = status.stats.embeddings || 0;
            }
        }

        async function getStats() {
            const loading = document.getElementById('pipeline-loading');
            const statsDiv = document.getElementById('pipeline-stats');
            
            loading.classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/api/pipeline/stats`);
                const data = await response.json();
                
                // Update header stats
                document.getElementById('stat-chapters').textContent = data.chapters;
                document.getElementById('stat-sections').textContent = data.sections;
                document.getElementById('stat-embeddings').textContent = data.section_embeddings;
                
                // Update detailed stats
                statsDiv.style.display = 'grid';
                statsDiv.innerHTML = `
                    <div class="stat-card">
                        <i class="fas fa-book"></i>
                        <div class="stat-card-value">${data.chapters}</div>
                        <div class="stat-card-label">Chapters</div>
                    </div>
                    <div class="stat-card success">
                        <i class="fas fa-bookmark"></i>
                        <div class="stat-card-value">${data.subchapters}</div>
                        <div class="stat-card-label">Subchapters</div>
                    </div>
                    <div class="stat-card warning">
                        <i class="fas fa-file-alt"></i>
                        <div class="stat-card-value">${data.sections}</div>
                        <div class="stat-card-label">Sections</div>
                    </div>
                    <div class="stat-card danger">
                        <i class="fas fa-brain"></i>
                        <div class="stat-card-value">${data.section_embeddings}</div>
                        <div class="stat-card-label">Embeddings</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching stats:', error);
            } finally {
                loading.classList.remove('active');
            }
        }

        async function runAnalysis() {
            const loading = document.getElementById('analysis-loading');
            const results = document.getElementById('analysis-results');
            const level = document.getElementById('analysis-level').value;
            
            loading.classList.add('active');
            results.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/api/analysis/similarity`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level })
                });
                const data = await response.json();
                
                results.innerHTML = `
                    <div class="results-container">
                        <div class="results-header">
                            <h3><i class="fas fa-chart-line"></i> Analysis Results</h3>
                            <span class="results-count">${data.total_pairs} pairs analyzed</span>
                        </div>
                `;
                
                if (data.results.length > 0) {
                    // Store results globally for click access
                    window.analysisResults = data.results;
                    
                    data.results.slice(0, 20).forEach((result, idx) => {
                        const simScore = (result.similarity_score * 100).toFixed(2);
                        const badgeClass = simScore >= 85 ? 'high' : simScore >= 75 ? 'medium' : '';
                        
                        results.innerHTML += `
                            <div class="result-item" style="cursor: pointer;" onclick="showAnalysisDetails(${idx})" data-result-idx="${idx}">
                                <div class="result-item-header">
                                    <div class="result-item-title">#${idx + 1} - Click for Details</div>
                                    <span class="similarity-badge ${badgeClass}">${simScore}%</span>
                                </div>
                                <div class="result-item-content">
                                    <strong>Item 1:</strong> ${result.item1_name || result.item1_id}<br>
                                    <strong>Item 2:</strong> ${result.item2_name || result.item2_id}<br>
                                    ${result.is_overlap ? '<span style="color: var(--warning);"><i class="fas fa-copy"></i> Overlap Detected</span> ' : ''}
                                    ${result.is_redundant ? '<span style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> Redundant</span>' : ''}
                                    <br><small style="color: var(--text-light);"><i class="fas fa-hand-pointer"></i> Click to view LLM justification</small>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    results.innerHTML += `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No Significant Similarities Found</h3>
                            <p>Try adjusting the similarity threshold or analyzing a different level.</p>
                        </div>
                    `;
                }
                
                results.innerHTML += '</div>';
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }

        async function getAnalysisSummary() {
            const loading = document.getElementById('analysis-loading');
            const results = document.getElementById('analysis-results');
            const level = document.getElementById('analysis-level').value;
            
            loading.classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/api/analysis/summary/${level}`);
                const data = await response.json();
                
                results.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-database"></i>
                            <div class="stat-card-value">${data.item_count}</div>
                            <div class="stat-card-label">Total Items</div>
                        </div>
                        <div class="stat-card success">
                            <i class="fas fa-equals"></i>
                            <div class="stat-card-value">${data.similarity_pairs}</div>
                            <div class="stat-card-label">Similarity Pairs</div>
                        </div>
                        <div class="stat-card warning">
                            <i class="fas fa-copy"></i>
                            <div class="stat-card-value">${data.overlaps}</div>
                            <div class="stat-card-label">Overlaps</div>
                        </div>
                        <div class="stat-card danger">
                            <i class="fas fa-clone"></i>
                            <div class="stat-card-value">${data.redundancies}</div>
                            <div class="stat-card-label">Redundancies</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }

        async function performClustering() {
            const loading = document.getElementById('clustering-loading');
            const results = document.getElementById('clustering-results');
            const level = document.getElementById('cluster-level').value;
            const nClustersInput = document.getElementById('cluster-n').value;
            const n_clusters = nClustersInput ? parseInt(nClustersInput) : null;
            
            loading.classList.add('active');
            results.innerHTML = '';

            try {
                const requestBody = { level };
                if (n_clusters) {
                    requestBody.n_clusters = n_clusters;
                }
                
                const response = await fetch(`${API_BASE}/api/clustering/cluster`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();
                
                const levelDesc = level === 'chapter' ? 'chapters (based on their sections)' : 
                                 level === 'subchapter' ? 'subchapters (based on their sections)' : 'sections';
                
                results.innerHTML = `
                    <div class="results-container">
                        <div class="results-header">
                            <h3><i class="fas fa-project-diagram"></i> K-Means Clustering Results</h3>
                            <span class="results-count">${data.num_clusters} clusters</span>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Algorithm:</strong> K-Means<br>
                                <strong>Items Clustered:</strong> ${data.num_items} ${levelDesc}
                            </div>
                        </div>
                `;
                
                if (data.clusters.length > 0) {
                    data.clusters.forEach(cluster => {
                        results.innerHTML += `
                            <div class="result-item">
                                <div class="result-item-header">
                                    <div class="result-item-title">
                                        <i class="fas fa-layer-group"></i> ${cluster.name || `Cluster ${cluster.label}`}
                                    </div>
                                    <span class="similarity-badge">${cluster.size} items</span>
                                </div>
                                <div class="result-item-content">
                                    ${cluster.summary ? `<p style="margin-bottom: 10px;"><strong>Summary:</strong> ${cluster.summary}</p>` : ''}
                                    <strong>Sample Items:</strong> ${cluster.items.slice(0, 5).map(item => 
                                        item.name || item.subject || item.section_number
                                    ).join(', ')}${cluster.items.length > 5 ? '...' : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                results.innerHTML += '</div>';
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }

        async function generateVisualizations() {
            const loading = document.getElementById('clustering-loading');
            const results = document.getElementById('clustering-results');
            const visContent = document.getElementById('visualizations-content');
            const level = document.getElementById('cluster-level').value;
            const nClustersInput = document.getElementById('cluster-n').value;
            const n_clusters = nClustersInput ? parseInt(nClustersInput) : null;
            
            loading.classList.add('active');

            try {
                const requestBody = { level };
                if (n_clusters) {
                    requestBody.n_clusters = n_clusters;
                }
                
                const response = await fetch(`${API_BASE}/api/visualization/clusters`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();
                
                const levelDesc = level === 'chapter' ? 'Chapter' : 
                                 level === 'subchapter' ? 'Subchapter' : 'Section';
                
                results.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Visualizations Generated!</strong><br>
                            ${data.num_clusters} ${levelDesc.toLowerCase()} clusters visualized using K-Means. Switch to the "Visuals" tab to view them.
                        </div>
                    </div>
                `;
                
                // Update visualizations tab
                visContent.innerHTML = '';
                const vis = data.visualizations;
                
                if (vis.tsne_2d) {
                    visContent.innerHTML += `
                        <div class="vis-card">
                            <img src="${vis.tsne_2d}" alt="t-SNE 2D" class="vis-card-image">
                            <div class="vis-card-body">
                                <div class="vis-card-title">
                                    <i class="fas fa-chart-scatter"></i>
                                    t-SNE 2D Visualization
                                </div>
                                <p style="color: var(--text-light); margin-bottom: 10px;">
                                    2D projection using t-SNE dimensionality reduction
                                </p>
                                <a href="${vis.tsne_2d}" target="_blank" class="vis-card-link">
                                    View Full Size <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                        </div>
                    `;
                }
                
                if (vis.pca_2d) {
                    visContent.innerHTML += `
                        <div class="vis-card">
                            <img src="${vis.pca_2d}" alt="PCA 2D" class="vis-card-image">
                            <div class="vis-card-body">
                                <div class="vis-card-title">
                                    <i class="fas fa-chart-area"></i>
                                    PCA 2D Visualization
                                </div>
                                <p style="color: var(--text-light); margin-bottom: 10px;">
                                    2D projection using Principal Component Analysis
                                </p>
                                <a href="${vis.pca_2d}" target="_blank" class="vis-card-link">
                                    View Full Size <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                        </div>
                    `;
                }
                
                if (vis.cluster_sizes) {
                    visContent.innerHTML += `
                        <div class="vis-card">
                            <img src="${vis.cluster_sizes}" alt="Cluster Sizes" class="vis-card-image">
                            <div class="vis-card-body">
                                <div class="vis-card-title">
                                    <i class="fas fa-chart-bar"></i>
                                    Cluster Sizes
                                </div>
                                <p style="color: var(--text-light); margin-bottom: 10px;">
                                    Distribution of items across clusters
                                </p>
                                <a href="${vis.cluster_sizes}" target="_blank" class="vis-card-link">
                                    View Full Size <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                        </div>
                    `;
                }
                
                if (vis.interactive_3d) {
                    visContent.innerHTML += `
                        <div class="vis-card">
                            <div class="vis-card-body" style="text-align: center; padding: 60px 20px;">
                                <i class="fas fa-cube" style="font-size: 4em; color: var(--primary); margin-bottom: 20px;"></i>
                                <div class="vis-card-title">
                                    <i class="fas fa-mouse-pointer"></i>
                                    Interactive 3D View
                                </div>
                                <p style="color: var(--text-light); margin: 10px 0 20px;">
                                    Explore clusters in 3D space
                                </p>
                                <a href="${vis.interactive_3d}" target="_blank" class="btn btn-primary">
                                    <i class="fas fa-external-link-alt"></i> Open Interactive View
                                </a>
                            </div>
                        </div>
                    `;
                }
                
                if (vis.cluster_report) {
                    visContent.innerHTML += `
                        <div class="vis-card">
                            <div class="vis-card-body" style="text-align: center; padding: 60px 20px;">
                                <i class="fas fa-file-alt" style="font-size: 4em; color: var(--success); margin-bottom: 20px;"></i>
                                <div class="vis-card-title">
                                    <i class="fas fa-chart-line"></i>
                                    Analysis Report
                                </div>
                                <p style="color: var(--text-light); margin: 10px 0 20px;">
                                    Comprehensive cluster statistics and insights
                                </p>
                                <a href="${vis.cluster_report}" target="_blank" class="btn btn-success">
                                    <i class="fas fa-download"></i> View Report
                                </a>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }

        async function queryRAG() {
            const loading = document.getElementById('rag-loading');
            const results = document.getElementById('rag-results');
            const query = document.getElementById('rag-query').value;
            const level = document.getElementById('rag-level').value;
            const top_k = parseInt(document.getElementById('rag-topk').value);
            
            if (!query.trim()) {
                results.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Please enter a query to search.</strong>
                    </div>
                `;
                return;
            }
            
            loading.classList.add('active');
            results.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/api/rag/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, level, top_k })
                });
                const data = await response.json();
                
                results.innerHTML = `
                    <div class="results-container">
                        <div class="results-header">
                            <h3><i class="fas fa-search"></i> Query Results</h3>
                            <span class="results-count">${data.results.length} results</span>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-quote-left"></i>
                            <strong>Query:</strong> "${data.query}"
                        </div>
                `;
                
                data.results.forEach((result, idx) => {
                    const simScore = (result.similarity_score * 100).toFixed(2);
                    const badgeClass = simScore >= 85 ? 'high' : simScore >= 75 ? 'medium' : '';
                    
                    // Use subject as title for sections
                    const title = result.type === 'section' ? 
                        (result.subject || result.section_number || `Result #${idx + 1}`) :
                        (result.name || `Result #${idx + 1}`);
                    
                    results.innerHTML += `
                        <div class="result-item" ${result.type === 'section' ? `style="cursor: pointer;" onclick="showSectionDetails(${result.id})"` : ''}>
                            <div class="result-item-header">
                                <div class="result-item-title">
                                    ${title}
                                </div>
                                <span class="similarity-badge ${badgeClass}">${simScore}%</span>
                            </div>
                            <div class="result-item-content">
                                ${result.section_number ? `<strong>Section:</strong> ${result.section_number}<br>` : ''}
                                ${result.chapter_name ? `<strong>Chapter:</strong> ${result.chapter_name}<br>` : ''}
                                ${result.subchapter_name ? `<strong>Subchapter:</strong> ${result.subchapter_name}<br>` : ''}
                                ${result.part_heading ? `<strong>Part:</strong> ${result.part_heading}<br>` : ''}
                                ${result.name ? `<strong>Name:</strong> ${result.name}<br>` : ''}
                                ${result.text ? `<strong>Preview:</strong> ${result.text.substring(0, 200)}...<br>` : ''}
                                ${result.type === 'section' ? '<br><small style="color: var(--text-light);"><i class="fas fa-hand-pointer"></i> Click to view full details</small>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                results.innerHTML += '</div>';
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }

        async function findSimilar() {
            const loading = document.getElementById('similarity-loading');
            const results = document.getElementById('similarity-results');
            const name = document.getElementById('sim-name').value;
            const search_type = document.getElementById('sim-type').value;
            const top_k = parseInt(document.getElementById('sim-topk').value);
            
            if (!name.trim()) {
                results.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Please enter an item name to search.</strong>
                    </div>
                `;
                return;
            }
            
            loading.classList.add('active');
            results.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/api/rag/similar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, search_type, top_k })
                });
                const data = await response.json();
                
                results.innerHTML = `
                    <div class="results-container">
                        <div class="results-header">
                            <h3><i class="fas fa-clone"></i> Similar Items</h3>
                            <span class="results-count">${data.results.length} found</span>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-search"></i>
                            <strong>Searching for:</strong> "${data.search_name}"
                        </div>
                `;
                
                data.results.forEach((result, idx) => {
                    const simScore = (result.similarity_score * 100).toFixed(2);
                    const badgeClass = simScore >= 85 ? 'high' : simScore >= 75 ? 'medium' : '';
                    
                    // Use subject as title for sections
                    const title = result.type === 'section' ? 
                        (result.subject || result.section_number || `Result #${idx + 1}`) :
                        (result.name || `Result #${idx + 1}`);
                    
                    results.innerHTML += `
                        <div class="result-item" ${result.type === 'section' ? `style="cursor: pointer;" onclick="showSectionDetails(${result.id})"` : ''}>
                            <div class="result-item-header">
                                <div class="result-item-title">${title}</div>
                                <span class="similarity-badge ${badgeClass}">${simScore}%</span>
                            </div>
                            <div class="result-item-content">
                                ${result.name ? `<strong>Name:</strong> ${result.name}<br>` : ''}
                                ${result.section_number ? `<strong>Section:</strong> ${result.section_number}<br>` : ''}
                                ${result.chapter_name ? `<strong>Chapter:</strong> ${result.chapter_name}<br>` : ''}
                                ${result.subchapter_name ? `<strong>Subchapter:</strong> ${result.subchapter_name}<br>` : ''}
                                ${result.part_heading ? `<strong>Part:</strong> ${result.part_heading}<br>` : ''}
                                ${result.type === 'section' && result.text ? `<strong>Preview:</strong> ${result.text.substring(0, 150)}...<br>` : ''}
                                ${result.type === 'section' ? '<br><small style="color: var(--text-light);"><i class="fas fa-hand-pointer"></i> Click to view full details</small>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                results.innerHTML += '</div>';
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }
        async function resetDatabase() {
            if (!confirm(' WARNING: This will delete ALL data including database, downloaded files, and visualizations. This action cannot be undone!\n\nAre you sure you want to continue?')) {
                return;
            }
            
            const loading = document.getElementById('pipeline-loading');
            const results = document.getElementById('pipeline-results');
            const statsDiv = document.getElementById('pipeline-stats');
            
            loading.classList.add('active');
            results.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/api/pipeline/reset`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                // Clear stats
                statsDiv.style.display = 'none';
                statsDiv.innerHTML = '';
                
                // Update header stats
                document.getElementById('stat-chapters').textContent = '0';
                document.getElementById('stat-sections').textContent = '0';
                document.getElementById('stat-embeddings').textContent = '0';
                
                results.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Database Reset Complete!</strong><br>
                            All data has been cleared. You can now start fresh with new data.
                        </div>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }

        async function showAnalysisDetails(resultIdx) {
            const result = window.analysisResults[resultIdx];
            if (!result) return;
            
            // Create modal or expanded view
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 16px; padding: 30px; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border);">
                    <h2 style="margin: 0; color: var(--dark);"><i class="fas fa-info-circle"></i> Analysis Details</h2>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);"></button>
                </div>
                <div id="modal-content">
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Loading LLM justification...</p>
                    </div>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Fetch detailed analysis
            try {
                // We need to get the similarity result ID - for now use the idx as approximation
                // In real implementation, store result IDs
                const simScore = (result.similarity_score * 100).toFixed(2);
                
                // For now, show available data
                document.getElementById('modal-content').innerHTML = `
                    <div class="result-item" style="margin-bottom: 20px;">
                        <div class="result-item-header">
                            <div class="result-item-title">Similarity Analysis</div>
                            <span class="similarity-badge ${simScore >= 85 ? 'high' : simScore >= 75 ? 'medium' : ''}">${simScore}%</span>
                        </div>
                        <div class="result-item-content">
                            <strong>Item 1:</strong> ${result.item1_name}<br>
                            <strong>Item 2:</strong> ${result.item2_name}<br><br>
                            
                            <strong>Overlap Status:</strong> ${result.is_overlap ? ' Yes' : ' No'}<br>
                            <strong>Redundant:</strong> ${result.is_redundant ? ' Yes' : ' No'}<br><br>
                            
                            <div style="background: var(--light); padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <strong><i class="fas fa-robot"></i> AI Analysis:</strong><br><br>
                                <p style="line-height: 1.6;">
                                    These items show ${simScore}% semantic similarity. 
                                    ${result.is_redundant ? 
                                        'This high similarity suggests significant redundancy. Consider consolidating these items to reduce duplication.' :
                                        result.is_overlap ?
                                        'There is notable overlap in content. Review whether these items serve distinct purposes or should be merged.' :
                                        'While related, these items maintain sufficient distinction to warrant separate entries.'}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('modal-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error loading details:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function showSectionDetails(sectionId) {
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 16px; padding: 30px; max-width: 900px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border);">
                    <h2 style="margin: 0; color: var(--dark);"><i class="fas fa-file-alt"></i> Section Details</h2>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);"></button>
                </div>
                <div id="section-modal-content">
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p style="margin-top: 15px;">Loading section details...</p>
                    </div>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Fetch section details
            try {
                const response = await fetch(`${API_BASE}/api/section/${sectionId}`);
                const section = await response.json();
                
                document.getElementById('section-modal-content').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0;">${section.subject || 'Section ' + section.section_number}</h3>
                            <p style="margin: 0; opacity: 0.9;">Section ${section.section_number}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            ${section.chapter_name ? `
                                <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                                    <strong style="color: var(--text-light); font-size: 0.9em;">Chapter</strong><br>
                                    <span style="color: var(--dark);">${section.chapter_name}</span>
                                </div>
                            ` : ''}
                            ${section.subchapter_name ? `
                                <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                                    <strong style="color: var(--text-light); font-size: 0.9em;">Subchapter</strong><br>
                                    <span style="color: var(--dark);">${section.subchapter_name}</span>
                                </div>
                            ` : ''}
                            ${section.part_heading ? `
                                <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                                    <strong style="color: var(--text-light); font-size: 0.9em;">Part</strong><br>
                                    <span style="color: var(--dark);">${section.part_heading}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${section.citation ? `
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--warning);">
                                <strong><i class="fas fa-bookmark"></i> Citation:</strong> ${section.citation}
                            </div>
                        ` : ''}
                        
                        ${section.section_label ? `
                            <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0c5460;">
                                <strong><i class="fas fa-tag"></i> Label:</strong> ${section.section_label}
                            </div>
                        ` : ''}
                        
                        <div style="background: var(--light); padding: 20px; border-radius: 12px; line-height: 1.8;">
                            <strong style="display: block; margin-bottom: 15px; font-size: 1.1em; color: var(--dark);">
                                <i class="fas fa-align-left"></i> Full Text:
                            </strong>
                            <p style="margin: 0; white-space: pre-wrap;">${section.text || 'No text available'}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('section-modal-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Error loading section:</strong> ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
